/* Copyright (c) 2022 Australian Government **********************************
'*  Name:        fbform.js 
'*  Description: Global javascipt snippets.
'*  Email:       wilson.wampers@gmail.com 
'*****************************************************************************
'*  Modification History:
'*  -When           -Who            -Bug#           -What
'*  --------------------------------------------------------------------------
'*  -08-Aug-2021    -Wilson Wampers -               -Version Upgrade
'****************************************************************************/
/* LM: ww.221222.2020_P */
var FB = FB || {}, len, stylesheet;

styleSheet = global.micor2020Path + 'css/recaptcha.css';
             global.loadCss(styleSheet);
styleSheet = global.micor2020Path + 'css/fbform.css';
             global.loadCss(styleSheet);

FB.debug =              false;
FB.verbose =            false;
FB.bError =             false;
FB.isShowing =          false;
FB.activeTrigger =      false;
FB.curWidth =           320;
FB.debugCntr =          1;
FB.formTitle =          'Your feedback helps make Micor better';
FB.formTYTitle =        'Thank you for your feedback';
FB.invalid =            'Please provide the required information!';
FB.captchaLabel =       'Please tick the \'robot\' checkbox';
FB.selectLabel =        'There is a problem with this text';
FB.commentLabel =       'What do you think is wrong with the selected text?';
FB.commentL320_1 =      'What is wrong with the selected text?';
FB.yesLabel =           'How was this page helpful?';
FB.noLabel =            'How could this page be more helpful?';
FB.yesNoLabel =         'NOT-SET'; 
FB.emailPlaceHolder =   'Please enter your email address';
FB.emailAddress =       '';
FB.rememberMe =         false;
FB.feedback =           'Some feedback content';
FB.PhoneUsUrl =         '/Pages/contact-us.aspx';
FB.InquiryUsUrl =       'https://www.agriculture.gov.au/general-inquiries';
FB.requireResponse =    'I would like a response';
FB.Msgs =               {};
FB.Msgs.Success =       'Thanks! Your feedback has been submitted.';
FB.Msgs.RobotError =    'Please confirm you\'re not a robot.';
FB.nErrors =            0;
FB.formType =           '';// CrowdSourcing | Helpful
FB.cookieExpires =      'Fri, 31 Dec 2038 12:00:00 UTC';
FB.submitButton =       null;
FB.cookieValues =       null;
FB.validation =         null;
FB.device =             ut.getDeviceInfo(); 
console.log('👀-> Device: ' + FB.device);

//****************************************************************************
// Desc: Debugging info
//****************************************************************************
FB.getCounter = function()
{
    return ('-=['+(ut.pad((FB.debugCntr++),4))+']=- ');
}

//****************************************************************************
// Desc:
//****************************************************************************
FB.init = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.init');

    var sHtml = '', formSwitch = 'not-set', oCookieData = {};

    FB.isForm = ( global.pathName.indexOf('website-feedback.aspx') != -1);

    if(global.IEVersion == -1) 
    {                                      
        if( FB.isForm )
        {
            document.getElementById('s4-workspace').style.visibility = 'hidden';
        }
    }
    $(document).ready(function()
    {  
        if( $('div#bgLayer', parent.document).length > 0) FB.isShowing = true;
        if(FB.isShowing)
        {
            console.clear();   
            if(global.IEVersion != -1) 
            {                                      
                if( FB.isForm )
                {
                    document.getElementById('s4-workspace').style.visibility = 'hidden';
                }
            }
            if(FB.isForm) $('body').prepend('<div id="valTrig" title="'+FB.invalid+'"></div>');
            $(window).on('resize', function()
            {
                FB.getCurWidth();
                FB.positionFormElements();
            });
            if( global.pathName.indexOf('website-feedback.aspx') != -1)
            {
                $('a.ms-signInLink').parent().css({display: 'none'});
                $('div#ms-designer-ribbon').hide();
                //S: from the old form
                FB.PageTitle = $.trim($('.page-content h1:first', parent.document.body).text()) || _spPageContextInfo.pageItemId;
                FB.PageUrl = (window.location != window.parent.location) ? window.parent.location.toString() : '';
                FB.PageUrl = FB.PageUrl ? FB.PageUrl.split('#')[0] : FB.PageUrl;
                //E: from the old form
                FB.oCookieData  = FB.getCookieData();
                FB.emailAddress = FB.oCookieData.emailaddress;
                FB.rememberMe   = ((FB.oCookieData.rememberme=='true')?true:false);

                sHtml += ' <div id="frameDialog">';
                sHtml += '      <div tabindex="0" id="btnClose" title="Click to close" class="fb965"><div class="closeBtn">';
                sHtml += '<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.5418 2.27956L16.7206 0.458313L9.50016 7.67873L2.27975 0.458313L0.458496 2.27956L7.67891 9.49998L0.458496 16.7204L2.27975 18.5416L9.50016 11.3212L16.7206 18.5416L18.5418 16.7204L11.3214 9.49998L18.5418 2.27956Z" fill="black"/></svg>';
                sHtml += '</div></div>';
                sHtml += '      <h3 class="dialogTitle">' + FB.formTitle + '</h3>';
                sHtml += '      <div id="fbnContent" class="fbnContent">';

                formSwitch = ut.getUrlSearchKey('Key');
                FB.getCurWidth();
                switch(formSwitch)
                {   
                    case 'comment' :
                        FB.formType = 'CrowdSourcing';
                        sHtml += FB.getRowContentComment();
                        break;
                    case 'yes' :
                        FB.setSelectOption('Yes');
                        FB.yesNoLabel = FB.yesLabel;
                        FB.formType = 'Helpful';
                        sHtml += FB.getRowContentYesNo();
                        break;
                    case 'no':
                        FB.setSelectOption('No');
                        FB.yesNoLabel = FB.noLabel;
                        FB.formType = 'Helpful';
                        sHtml += FB.getRowContentYesNo();
                        break;
                    default: 
                        FB.formType = 'CrowdSourcing';
                        sHtml += FB.getRowContentComment();
                }
                sHtml += '          <table id="fbnButtons" class="fb965">';
                sHtml += '            <tr>';
                sHtml += '              <td class="btnCell" colspan="5">';
                sHtml += '                 <div id="btnRow" class="btnRow">';
                sHtml += '                   <input tabindex="0" class="fbnBtn" id="fbnCancel" type="button" value="Cancel" />';
                sHtml += '                 </div>';
                sHtml += '              </td>';
                sHtml += '            </tr>';
                sHtml += '          </table>';
                sHtml += '      </div>';
                sHtml += '</div>';

                $('body').prepend(sHtml);
                // set focus
                if(global.IEVersion == -1) 
                {
                    if(FB.formType == 'CrowdSourcing') $('#txaComment').focus();
                    else $('#txaFeedback').focus();
                }
                else // IE
                {
                    setTimeout(function()
                    {
                        if(FB.formType == 'CrowdSourcing') 
                            $('#txaComment').select().focus();
                        else 
                            $('#txaFeedback').select().focus();
                    }, 50);
                }

                $('input[name*="_PageTitle"]').val(FB.formType);
                $('input[name*="_PageUrl"]').val(FB.PageUrl);
                $('input[id*="_btnSubmit"]').addClass('fbnBtn').prop('disabled', true);
                $('input[id*="_btnSubmit"]').on('mouseenter',
                function()
                {
                    FB.isValidForm();
                });
                FB.positionFormElements();
                // Layer to trigger form validation
                $('div#valTrig').on('mouseenter', FB.preSubmitChecks);
                $('div#valTrig').on('click', FB.preSubmitChecks);
                $('div.closeBtn').on('mousedown', function() 
                { 
                    try 
                    { 
                        top.fbn._Close(); 
                    } 
                    catch(ex) { ; }
                });
                $('input#fbnCancel').on('mousedown', function() 
                { 
                    try { top.fbn._Close(); } catch(ex) {;}
                });
                // Don't allow users to change the selected text
                $('#txaSelected').on('focus', function()
                {
                    $(this).blur(); 
                });
                if( FB.formType == 'Helpful' )
                {// Attach an event handler to the email formSlider checkbox
                    $('input[type=checkbox]#elSwitch').on('change', function()
                    {
                        FB.setSpanStarEColor();
                    });
                    $('span.spanStarE').css({'color': 'white'});
                } 
            }
            // Captcha stuff
            $('div.g-recaptcha').wrap('<div id="fbnCaptcha" class="fb965"></div>');
            $('div#fbnCaptcha').append('<div id="fbnCaptcha_Error" class="fb965"></div>');
            $('<label class="fbnCLabel">' + FB.captchaLabel + '<span class="spanStar">*&nbsp;</span></label>').insertBefore('div#fbnCaptcha');
            try
            {
                if(top.fbn.isLoaded)
                {
                    top.fbn.isLoaded = false;
                    top.fbn.showIframe();
                }
            }
            catch(e) {;}
            FB.enableValidation();
        } 
    });
}

//****************************************************************************
// Desc: Re-enable validation upon field(s) changes
//****************************************************************************
FB.enableValidation = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.enableValidation');

    if(FB.isShowing)
    {
        switch(FB.formType)
        {
            case 'CrowdSourcing':
            {
                $('#txaComment').on('change', FB.positionValTrig);
                $('txtEmailAddress').on('change', FB.positionValTrig);

                break;
            }
            case 'Helpful':
            {
                $('#txaFeedback').on('change', FB.positionValTrig);
                $('input[type=checkbox]#elSwitch').on('change', FB.positionValTrig);
                $('txtEmailAddress').on('change', FB.positionValTrig);

                break;
            }
        }
    }
}

//****************************************************************************
// Desc:
//****************************************************************************
FB.getCurWidth = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.getCurWidth');

    var iFW = parseInt($(window).width(), 10);

    if(FB.isShowing)
    {
        if(FB.verbose)
            console.log('== Form frame width: ' 
                + iFW + ' window: ' + $('form').prop('action'));

        switch(true)
        {
            case (iFW > 680):
                if(FB.debug)
                    console.log('1-getCurWidth case ('
                        +iFW+' > 680) p:' + top.window.innerWidth);

                if(top.window.innerWidth > 395)
                    FB.curWidth = 965;
                else
                    FB.curWidth = 320;  

                break;
            case (iFW <= 680 && iFW > 480):
                if(FB.debug)
                    console.log('2-getCurWidth case ('
                        +iFW+' <= 680 && '+iFW+' > 480) p:' + top.window.innerWidth);

                FB.curWidth = 680;

                break;
            case (iFW <= 480 && iFW > 320):
                if(FB.debug)
                    console.log('3-getCurWidth case ('
                        +iFW+' <= 480 && '+iFW+' > 320) p:' + top.window.innerWidth);

                FB.curWidth = 480;

                break;
            case (iFW <= 320):
                if(FB.debug)
                    console.log('4-getCurWidth case ('
                        +iFW+' <= 320) p:'  + top.window.innerWidth);

                FB.curWidth = 320;

                break;
        }
    }
    else
    {
        if(FB.verbose)
            console.log('== Form frame width: ' 
                + iFW + ' window: ' + $('form').prop('action'));
    }
}

//****************************************************************************
// Desc:
//****************************************************************************
FB.preSubmitChecks = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.preSubmitChecks');

    switch(FB.formType)
    {
        case 'CrowdSourcing':
        {
            var outputHtml = top.fbn.userSelHtml;
            var sCleaned   = outputHtml.replace(/[\u200B-\u200D\uFEFF]/g, '');
            if(global.verbose) console.log('outputHtml: ' + sCleaned);
            FB.feedback = 'userComment:\n'       + $('#txaComment').val() 
                        + '\nuserEmailAddress:\n'+ $('#txtEmailAddress').val()
                        + '\nuserSelected:\n'    + $('#txaSelected').val() 
                        + '\nhtmlSelected:\n'    + outputHtml;

            break;  
        }
        case 'Helpful':
        {
            if($('input[type=checkbox]#elSwitch').prop('checked'))
            {
                FB.feedback = 'userFeedBack:\n'       + $('#txaFeedback').val() 
                            + '\nuserEmailAddress:\n' + $('#txtEmailAddress').val();
            } 
            else
            {
                FB.feedback = 'userFeedBack:\n'+ $('#txaFeedback').val();   
            }
            break;
        }
    }
    $('textarea[name*="_PageFeedback"]').val(FB.feedback);
    if(FB.isValidForm())
    {
        clearTimeout(FB.validation);
        FB.validation = null;
        FB.positionFormElements();
        FB.setGoogleAnalytics();
        oCookieData = 
        {
            'emailAddress': $('#txtEmailAddress').val(), 
            'rememberMe'  : ($('input#chkRememberMe').prop('checked')?'true':'false'),
            'formType'    : FB.formType
        }
        if($('input#chkRememberMe').prop('checked'))
        {
            FB.pushCookie(oCookieData);
        }
        $('input[id*="_btnSubmit"]').prop('disabled', false);
        $('div#valTrig').hide();
        $('table#fbnButtons').off('mouseover');
        $('#frameDialog').off('mousemove');
    }
    else
    {
        $('#frameDialog').on('mousemove', function()
        {
            if(!FB.validation)
                FB.validation = setTimeout( function()
                {
                    FB.isValidForm();
                }, 100 );
        });
    }
}

//****************************************************************************
// Desc: Set the matching option value to selected
//****************************************************************************
FB.setSpanStarEColor = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.setSpanStarEColor');

    if($('input[type=checkbox]#elSwitch').prop('checked'))
    {
        if(FB.verbose) console.log(' -> I want response checkbox changed event');
        $('#grey_overlay').hide();
        $('span.spanStarE').css({'color': 'rgb(220, 21, 21)'});
    }
    else
    {
        if(FB.verbose) console.log(' -> I don\'t want response checkbox changed event');
        $('#grey_overlay').show();
        $('span.spanStarE').css({'color': 'white'});
    }
}

//****************************************************************************
// Desc: Set the matching option value to selected
//****************************************************************************
FB.setSelectOption = function(psValue)
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.setSelectOption');

    var oSelect;
    // First remove if any dirty settings (re-used form)
    oSelect = $('select[id*="ddl_PageHelpful"]').eq(0);
    oSelect.find('option').each(function()
    {
        if($(this).attr('selected')) $(this).removeAttr('selected');
    });
    // Now set the psValue match to selected
    oSelect.find('option').each(function()
    {
        if($(this).val() == psValue)
        {
            $(this).prop('selected', true);
        }
    });
}

//****************************************************************************
// Desc:
//****************************************************************************
FB.getRowContentComment = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.getRowContentComment');

    var sHtml = '';

    sHtml += '<table id="fbnTable" class="fbnTable">';
    sHtml += ' <tbody id="Comment">';
    sHtml += '  <tr id="tblSizer">';
    sHtml += '    <td class="td1">&nbsp;</td>';
    sHtml += '    <td class="td2">&nbsp;</td>';
    sHtml += '    <td class="td3">&nbsp;</td>';
    sHtml += '    <td class="td4">&nbsp;</td>';
    sHtml += '    <td class="td5">&nbsp;</td>';
    sHtml += '  </tr>';
    sHtml += '  <tr class="trLabel">';
    sHtml += '    <td class="fbSelected" colspan="5">'
                + FB.selectLabel
                +'</td>';
    sHtml += '  </tr>';
    sHtml += '  <tr>';
    sHtml += '    <td class="txaSelected" colspan="5">'
                + '<textarea id="txaSelected" class="fb965">'
                + FB.getUserSelected()
                +'</textarea>'
                +'</td>';
    sHtml += '  </tr>';
    sHtml += '  <tr class="trLabel">';
    sHtml += '    <td id="cmmtLbl" class="fbSelected" colspan="5">'
                + FB.commentLabel 
                + '<span class="spanStar">*&nbsp;</span>' 
                +'</td>';
    sHtml += '  </tr>';
    sHtml += '  <tr>';
    sHtml += '    <td class="txaComment" colspan="5">'
                + '<textarea tabindex="0" id="txaComment" class="fb965"></textarea><br/>'
                + '<div id="txaComment_Error"></div>';
                +'</td>';
    sHtml += '  </tr>';
    sHtml += '  <tr class="row5">';
    sHtml += '    <td colspan="5">';
    sHtml += '      <div class="emailFlex965">'
                + '   <div class="lblEmailAddress">'
                + '     <span>Email Address</span><span class="spanStar">*&nbsp;</span>'
                + '   </div>'
                + '   <div class="emailAddress">'
                + '     <input tabindex="0" id="txtEmailAddress" type="text" class="fb965" '
                + '     placeholder="'+ FB.emailPlaceHolder +'" value="'+FB.emailAddress+'" />'
                + '     <div style="width: 100%">'
                + '       <span id="txtEmailAddress_Error" class="fb965"></span>'
                + '     </div>'
                + '   </div>'
                + '   <div id="rememberMe" class="fb965"><span nowrap>'
                +   ((FB.rememberMe)?
                '     <input tabindex="0" id="chkRememberMe" type="checkbox" class="fb965" checked />':
                '     <input tabindex="0" id="chkRememberMe" type="checkbox" class="fb965"/>')
                + '&nbsp;<span>Remember me</span></span>'
                + '   </div>'
    sHtml += '      </div>';
    sHtml += '    </td>';
    sHtml += '  </tr>';
    sHtml += ' </tbody>';
    sHtml += '</table>';

    return sHtml;
}

//****************************************************************************
// Desc:
//****************************************************************************
FB.getRowContentYesNo = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.getRowContentYesNo');

    var sHtml = '';

    sHtml += '<table id="fbnTable" class="fbnTable">';
    sHtml += ' <tbody id="Yes">';
    sHtml += '  <tr id="tblSizer">';
    sHtml += '    <td class="td1">&nbsp;</td>';
    sHtml += '    <td class="td2">&nbsp;</td>';
    sHtml += '    <td class="td3">&nbsp;</td>';
    sHtml += '    <td class="td4">&nbsp;</td>';
    sHtml += '    <td class="td5">&nbsp;</td>';
    sHtml += '  </tr>';
    sHtml += '  <tr class="trLabel">';
    sHtml += '    <td class="fbFeedback" colspan="5">'
                + FB.yesNoLabel + '<span class="spanStar">*&nbsp;</span>'
                +'</td>';
    sHtml += '  </tr>';
    sHtml += '  <tr>';
    sHtml += '    <td class="txaFeedback" colspan="5">'
                + '<textarea tabindex="0" id="txaFeedback" class="fb965"></textarea><br/>'
                + '<div id="txaFeedback_Error"></div>';
                +'</td>';
    sHtml += '  </tr>';
// 
    sHtml += '  <tr class="switchRow">';
    sHtml += '    <td colspan="5"><div class="switchYN">';
    sHtml += '      <span><label tabindex="0" class="switch" for="elSwitch"><input id="elSwitch" type="checkbox"><span class="formSlider round"></span></label></span>';
    sHtml += '      <span class="requireResponse">' + FB.requireResponse + '</span></div>';
    sHtml += '    </td>';           
    sHtml += '  </tr>';
//
    sHtml += '  <tr class="rowYN">';
    sHtml += '    <td colspan="5">';
    sHtml += '      <div class="emailFlex965">'
                + '   <div class="lblEmailAddress">'
                + '     <span>Email Address</span><span class="spanStarE">*&nbsp;</span>'
                + '   </div>'
                + '   <div class="emailAddress">'
                + '     <input tabindex="0" id="txtEmailAddress" type="text" class="fb965" '
                + '     placeholder="'+ FB.emailPlaceHolder +'" value="'+FB.emailAddress+'" />'
                + '     <div style="width: 100%">'
                + '       <span id="txtEmailAddress_Error" class="fb965"></span>'
                + '     </div>'
                + '   </div>'
                + '   <div id="rememberMe" class="fb965"><span nowrap>'
                +   ((FB.rememberMe)?
                '     <input tabindex="0" id="chkRememberMe" type="checkbox" class="fb965" checked />':
                '     <input tabindex="0" id="chkRememberMe" type="checkbox" class="fb965"/>')
                + '&nbsp;<span>Remember me</span></span>'
                + '   </div>'
    sHtml += '      </div>';
    sHtml += '    </td>';           
    sHtml += '  </tr>';
    sHtml += ' </tbody>';
    sHtml += '</table>';
    sHtml += '<div id="grey_overlay"></div>';

    return sHtml;
}

//****************************************************************************
// Desc: Only in production connect up to Google Analytics
//****************************************************************************
FB.setGoogleAnalytics = function()
{
    var sAnalyticsHost = window.location.host.split('.')[0];

    if(global.verbose) console.log('sAnalyticsHost: ' + sAnalyticsHost);
    if( sAnalyticsHost == 'micor' )
    {
        if( typeof window.parent.gtag !== undefined ) 
        {
            try 
            {
                switch(FB.formType)
                {
                    case 'CrowdSourcing':    
                        window.parent.gtag('event', 'CrowdSourcing', 
                        {
                            'event_category': 'CrowdSourcing',
                            'event_label': FB.PageUrl,
                        });

                        break;
                    case 'Helpful':
                        window.parent.gtag('event', top.fbn.formSwitch, 
                        {
                            'event_category': 'WasThisPageHelpful',
                            'event_label': FB.PageUrl,
                        });

                        break;
                }
            }
            catch(err) 
            {
                console.log('⛔️ Google analytics: ' + err.message);
            }
        }
    }
}

//****************************************************************************
// Desc: Crude form validation
//****************************************************************************
FB.isValidForm = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.isValidForm');

    var bValid = false;
    
    FB.captchaError = '';
    FB.validation   = false;
    if(global.verbose) console.log('passing --> FB.isValidForm');

    // First remove/reset classes :: all errors
    $('.fieldError').each(function()
    {
        $(this).removeClass('fieldError');
        if(FB.formType == 'Helpful')
        {
            $('#txaFeedback_Error').removeClass('on').addClass('off');
            $('#txtEmailAddress_Error').removeClass('onYN').addClass('off');
        }
        else
        {
            $('#txaComment_Error').removeClass('on').addClass('off');
            $('#txtEmailAddress_Error').removeClass('on').addClass('off');
        }
        $('#fbnCaptcha_Error').removeClass('on').addClass('off');
    });

    switch(FB.formType)
    {
        case 'CrowdSourcing':
        {
            switch($('#txaComment').val())
            {
                case '':
                    $('#txaComment').addClass('fieldError');
                    FB.txaCommentError = '* this is a required field';
                    $('#txaComment_Error').text(FB.txaCommentError);
                    $('#txaComment_Error').removeClass('off');
                    $('#txaComment_Error').addClass('on');
                    break;
            }

            break;
        }
        case 'Helpful':
        {
            switch($('#txaFeedback').val())
            {
                case '':
                    $('#txaFeedback').addClass('fieldError');
                    FB.txaFeedbackError = '* this is a required field';
                    $('#txaFeedback_Error').text(FB.txaFeedbackError);
                    $('#txaFeedback_Error').removeClass('off');
                    $('#txaFeedback_Error').addClass('on');
                    break;
            }

            break;
        }
    }

    switch($('#txtEmailAddress').val())
    {
        case '':
            if($('input[type=checkbox]#elSwitch').prop('checked') 
            || FB.formType == 'CrowdSourcing' )
            {
                $('#txtEmailAddress').addClass('fieldError');
                FB.emailAddressError = '* this is a required field';
                $('#txtEmailAddress_Error').text(FB.emailAddressError);
                $('#txtEmailAddress_Error').removeClass('off');
                if(FB.formType == 'Helpful')
                {
                    $('#txtEmailAddress_Error').addClass('onYN'); 
                }
                else
                {
                    $('#txtEmailAddress_Error').addClass('on');
                }
                break;
            }
        default: 
            var bValidEmail = FB.isEmail($('#txtEmailAddress').val());

            if($('input[type=checkbox]#elSwitch').prop('checked') 
            || FB.formType == 'CrowdSourcing' )
            {
                if(!bValidEmail)
                {
                    $('#txtEmailAddress').addClass('fieldError');
                    FB.emailAddressError = '* please enter a valid email address';
                    $('#txtEmailAddress_Error').text(FB.emailAddressError);
                    $('#txtEmailAddress_Error').removeClass('off');
                    if(FB.formType == 'Helpful')
                    {
                        $('#txtEmailAddress_Error').addClass('onYN'); 
                    }
                    else
                    {
                        $('#txtEmailAddress_Error').addClass('on');
                    }
                }
            }
    }

    if(FB.debug) console.log('👉 Captcha Val: ' + $('#g-recaptcha-response').val());
    switch($('#g-recaptcha-response').val())
    {
        case '':
            $('#fbnCaptcha').addClass('fieldError');
            FB.captchaError = '* please indicate you\'re not a robot';
            $('#fbnCaptcha_Error').text(FB.captchaError);
            $('#fbnCaptcha_Error').removeClass('off');
            if(FB.formType == 'Helpful')
            {
                $('#fbnCaptcha_Error').addClass('onYN'); 
            }
            else
            {
                $('#fbnCaptcha_Error').addClass('on');
            }
            break;
        default:
            $('#fbnCaptcha_Error').text('');
            $('#fbnCaptcha_Error').removeClass();
            break;
    }
    FB.positionFormElements();

    FB.nErrors = 0;
    $('.fieldError').each( function() {FB.nErrors++} );
    if( FB.nErrors == 0 ) 
    {
        bValid = true;
    }

    return bValid;
}

//****************************************************************************
// Desc: Crude email validation regex (subject to discussion)
//****************************************************************************
FB.isEmail = function(psEmail) 
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.isEmail');

    return typeof psEmail==='string' && /^[\w+\d+._]+\@[\w+\d+_+]+\.[\w+\d+._]{2,8}$/.test(psEmail);
}

//****************************************************************************
// Desc: /\r?\n|\r/g
//****************************************************************************
FB.getUserSelected = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.getUserSelected');

    var sUserSelected = $('footer > div.outputText', window.parent.document).text()
                        .replace(/\r?\n|\r/g, '')
                        .replace(/&ZeroWidthSpace/g, '')
                        .replace(/  +/g, ' ');

    return sUserSelected;
}

//****************************************************************************

{/* Cookie works */
//****************************************************************************
// Desc:
//****************************************************************************
FB.getCookieData = function()
{ 
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.getCookieData');

    FB.oCookieContent = ut.getCookie('micor-feedback');
    if(typeof FB.oCookieContent != 'undefined')
    {
        FB.oCookieData  = JSON.parse(FB.oCookieContent);
        FB.emailAddress = FB.oCookieData.emailaddress;
        FB.nSubmissions = FB.oCookieData.submissions;
        FB.dLastVisit   = FB.oCookieData.lastvisitdate;
        FB.rememberMe   = FB.oCookieData.rememberme;
        FB.formType     = FB.oCookieData.formtype;
    }

    var oCookieData = 
    {
        'emailaddress' : FB.emailAddress,
        'rememberme'   : FB.rememberMe
    }

    return oCookieData;
}

//****************************************************************************
// Desc:
//****************************************************************************
FB.pushCookie = function(poCookieData)
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.pushCookie');

    var JSONString, oCookieContent, oCookieValues;

    FB.emailAddress = poCookieData.emailAddress;
    FB.rememberMe   = poCookieData.rememberMe;
    FB.formType     = poCookieData.formType;
    FB.nSubmissions = (!isNaN(FB.nSubmissions))? ++FB.nSubmissions: 1;

    if(global.verbose) console.log('=> feedback --> remember me: cookie writing enabled!');
    oCookieContent = 
    {
        'emailaddress' : FB.emailAddress,
        'submissions'  : FB.nSubmissions,
        'lastvisitdate': new Date().toDateString(),
        'rememberme'   : FB.rememberMe,
        'formtype'     : FB.formType
    }
    JSONString = JSON.stringify(oCookieContent);
    
    if(location.host.toLowerCase().indexOf('authoring') == -1)
    {
        oCookieValues = 'micor-feedback=' 
                      + ut.secEncode(JSONString) 
                      + '; expires='+FB.cookieExpires+'; path=/; SameSite=Lax; Secure;';
        if(global.verbose) console.log('Feedback cookie - encoded: ' + oCookieValues);
    }
    else
    {
        oCookieValues = 'micor-feedback=' 
                      + JSONString 
                      + '; expires='+FB.cookieExpires+'; path=/; SameSite=Lax;';
        if(global.verbose) console.log('Feedback cookie - unencoded: ' + oCookieValues);
    }

    ut.setCookie(oCookieValues);
}
}

//****************************************************************************
// Desc:
//****************************************************************************
FB.positionFormElements = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.positionFormElements');

    switch(FB.curWidth)
    {
        case (965):
            FB.applyMediaClasses(965);

            break;
        case (680):
            FB.applyMediaClasses(680);

            break;
        case (480):
            FB.applyMediaClasses(480);

            break;
        case (320):
            FB.applyMediaClasses(320);
            
            break;
    }
    if(!FB.activeTrigger) 
        FB.posValTrig = setTimeout(FB.positionValTrig, 750);
}

//****************************************************************************
// Desc:FB965, FB680
//****************************************************************************
FB.applyMediaClasses = function(pnVal)
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.applyMediaClasses');

    switch(pnVal)
    {
        case 965:
            if(FB.debug) console.log('⚡ - Current case 965');

            FB.applyCodedStyles(965);
            break;
        case 680:
            if(FB.debug) console.log('⚡ - Current case 680');

            FB.applyCodedStyles(680);
            break;
        case 480:
            if(FB.debug) console.log('⚡ - Current case 480');

            FB.applyCodedStyles(480);
            break;
        case 320:
            if(FB.debug) console.log('⚡ - Current case 320');

            FB.applyCodedStyles(320);
            break;
    }
}

//****************************************************************************
// Desc: Due to CSS @media bug in chromium
//****************************************************************************
FB.applyCodedStyles = function(pnVal)
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.applyCodedStyles');

    switch(pnVal)
    {
        case 965:

            FB.applyStyle965();
            $('input[id*="_btnSubmit"]').css(
            {
                position: 'fixed',
                top: '485px', 
                left: '670px', 
                'z-index': 6, 
                visibility: 'visible'
            });
            $('input[id*="fbnCancel"]').css(
            {
                position: 'fixed', 
                top: '501px', 
                left: '797px', 
                'z-index': 6
            });
            if(FB.formType == 'Helpful')
            {
                FB.setSpanStarEColor();
                $('span[id*="_recaptcha"]').css(
                {
                    position:'fixed', 
                    top: '474px', 
                    left: '40px', 
                    visibility: 'visible', 
                    'z-index': '10'
                });
            }
            else // Crowdsourcing
            {
                sHtml = FB.commentLabel + '<span class="spanStar">*&nbsp;</span>';
                $('#cmmtLbl').html(sHtml);
                $('span[id*="_recaptcha"]').css(
                {
                    position:'fixed', 
                    top: '472px', 
                    left: '40px', 
                    visibility: 'visible', 
                    'z-index': '10'
                });
            }
            
            break;

        case 680:
            
            FB.applyStyle680();
            $('input[id*="_btnSubmit"]').css(
            {
                position: 'fixed',
                top: '485px', 
                left: '400px', 
                'z-index': 6, 
                visibility: 'visible'
            });
            $('input[id*="fbnCancel"]').css(
            {
                position: 'fixed', 
                top: '501px', 
                left: '520px', 
                'z-index': 6
            });
            if(FB.formType == 'Helpful')
            {
                FB.setSpanStarEColor();
                $('span[id*="_recaptcha"]').css(
                {
                    position:'fixed', 
                    top: '474px', 
                    left: '40px', 
                    visibility: 'visible', 
                    'z-index': '10'
                });
            }
            else  // Crowdsourcing
            {
                sHtml = FB.commentLabel + '<span class="spanStar">*&nbsp;</span>';
                $('#cmmtLbl').html(sHtml);
                $('span[id*="_recaptcha"]').css(
                {
                    position:'fixed', 
                    top: '472px', 
                    left: '40px', 
                    visibility: 'visible', 
                    'z-index': '10'
                });
            }
            
            break;

        case 480:
            
            FB.applyStyle480();
            $('input[id*="_btnSubmit"]').css(
            {
                position: 'fixed',
                top: '560px', 
                left: '112px', 
                'z-index': 6, 
                visibility: 'visible'
            });
            $('input[id*="fbnCancel"]').css(
            {
                position: 'fixed', 
                top: '576px', 
                left: '239px', 
                'z-index': 6
            });
            if(FB.formType == 'Helpful')
            {
                FB.setSpanStarEColor();
                $('span[id*="_recaptcha"]').css(
                {
                    position:'fixed', 
                    top: '460px', 
                    left: '86px', 
                    visibility: 'visible', 
                    'z-index': '10'
                });
            }
            else  // Crowdsourcing
            {
                sHtml = FB.commentLabel + '<span class="spanStar">*&nbsp;</span>';
                $('#cmmtLbl').html(sHtml);
                $('span[id*="_recaptcha"]').css(
                {
                    position:'fixed', 
                    top: '460px', 
                    left: '86px', 
                    visibility: 'visible', 
                    'z-index': '10'
                });
            }
            
            break;

        case 320:

            FB.applyStyle320();
            $('input[id*="_btnSubmit"]').css(
            {
                position: 'fixed',
                top: '560px', 
                left: '33px', 
                'z-index': 6, 
                visibility: 'visible'
            });
            $('input[id*="fbnCancel"]').css(
            {
                position: 'fixed', 
                top: '576px', 
                left: '160px', 
                'z-index': 6
            });
            if(FB.formType == 'Helpful')
            {
                FB.setSpanStarEColor();
                $('span[id*="_recaptcha"]').css(
                {
                    position:'fixed', 
                    top: '460px', 
                    left: '8px', 
                    visibility: 'visible', 
                    'z-index': '10'
                });
            }
            else // Crowdsourcing
            {
                sHtml = '<span class="s_1_320">' + FB.commentL320_1
                      + '<span class="spanStar">*&nbsp;</span></span>'
                $('#cmmtLbl').html(sHtml);
                $('span[id*="_recaptcha"]').css(
                {
                    position:'fixed', 
                    top: '472px', 
                    //top: '460px',
                    left: '8px', 
                    visibility: 'visible', 
                    'z-index': '10'
                });
            }
            
            break;
    }
}

//****************************************************************************
// Desc: Due to CSS @media bug in chromium | maps classes to viewfield
//****************************************************************************
FB.applyStyle965 = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.applyStyle965');

    $('div#frameDialog').css({'background-color': 'rgba(255, 255, 255, 1)'});
    $('#frameDialog h3[class*="dialogTitle"]').removeClass().addClass('dialogTitle');
    $('table[class*="fbnTable"]').removeClass().addClass('fbnTable');
    ($('#txaFeedback').hasClass('fieldError'))? 
        $('#txaFeedback').removeClass().addClass('fb965 fieldError'):
        $('#txaFeedback').removeClass().addClass('fb965');
    $('#txaSelected').removeClass().addClass('fb965');
    ($('#txaComment').hasClass('fieldError'))? 
        $('#txaComment').removeClass().addClass('fb965 fieldError'):
        $('#txaComment').removeClass().addClass('fb965');
    $('td[class*="fbFeedback"]').removeClass().addClass('fbFeedback');
    $('td[class*="fbSelected"]').removeClass().addClass('fbSelected');
    $('div[class*="emailFlex"]').removeClass().addClass('emailFlex965');
    $('div[class*="lblEmailAddress"]').removeClass().addClass('lblEmailAddress965');
    ($('#txtEmailAddress').hasClass('fieldError'))? 
        $('#txtEmailAddress').removeClass().addClass('fb965 fieldError'):
        $('#txtEmailAddress').removeClass().addClass('fb965');
    $('#rememberMe').removeClass().addClass('fb965');
    $('#chkRememberMe').removeClass().addClass('fb965');
    $('table#fbnButtons').removeClass().addClass('fb965');
    $('#btnClose').removeClass().addClass('fb965');
    $('#grey_overlay').removeClass().addClass('fb965');
    $('#txaFeedback_Error.on').removeClass().addClass('on fb965');
    $('#txaComment_Error.on').removeClass().addClass('on fb965');
    $('#txtEmailAddress_Error.on').removeClass().addClass('on fb965');
    $('#txtEmailAddress_Error.onYN').removeClass().addClass('onYN fb965');
    $('#fbnCaptcha_Error.on').removeClass().addClass('on fb965');
    $('#fbnCaptcha_Error.onYN').removeClass().addClass('onYN fb965');
    $('div#valTrig').removeClass().addClass('fb965');
}

//****************************************************************************
// Desc: Due to CSS @media bug in chromium | maps classes to viewfield
//****************************************************************************
FB.applyStyle680 = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.applyStyle680');

    $('div#frameDialog').css({'background-color': 'rgba(255, 255, 255, 1)'});
    $('#frameDialog h3[class*="dialogTitle"]').removeClass().addClass('dialogTitle680');
    $('table[class*="fbnTable"]').removeClass().addClass('fbnTable680');
    ($('#txaFeedback').hasClass('fieldError'))? 
        $('#txaFeedback').removeClass().addClass('fb680 fieldError'):
        $('#txaFeedback').removeClass().addClass('fb680');
    $('#txaSelected').removeClass().addClass('fb680');
    ($('#txaComment').hasClass('fieldError'))? 
        $('#txaComment').removeClass().addClass('fb680 fieldError'):
        $('#txaComment').removeClass().addClass('fb680');
    $('td[class*="fbFeedback"]').removeClass().addClass('fbFeedback680');
    $('td[class*="fbSelected"]').removeClass().addClass('fbSelected680');
    $('div[class*="emailFlex"]').removeClass().addClass('emailFlex680');
    $('div[class*="lblEmailAddress"]').removeClass().addClass('lblEmailAddress680');
    ($('#txtEmailAddress').hasClass('fieldError'))? 
        $('#txtEmailAddress').removeClass().addClass('fb680 fieldError'):
        $('#txtEmailAddress').removeClass().addClass('fb680');
    $('#rememberMe').removeClass().addClass('fb680');
    $('#chkRememberMe').removeClass().addClass('fb680');
    $('table#fbnButtons').removeClass().addClass('fb680');
    $('#btnClose').removeClass().addClass('fb680');
    $('#grey_overlay').removeClass().addClass('fb680');
    $('#txaFeedback_Error.on').removeClass().addClass('on fb680');
    $('#txaComment_Error.on').removeClass().addClass('on fb680');
    $('#txtEmailAddress_Error.on').removeClass().addClass('on fb680');
    $('#txtEmailAddress_Error.onYN').removeClass().addClass('onYN fb680');
    $('#fbnCaptcha_Error.on').removeClass().addClass('on fb680');
    $('#fbnCaptcha_Error.onYN').removeClass().addClass('onYN fb680');
    $('div#valTrig').removeClass().addClass('fb680');
}

//****************************************************************************
// Desc: Due to CSS @media bug in chromium | maps classes to viewfield
//****************************************************************************
FB.applyStyle480 = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.applyStyle480');

    $('div#frameDialog').css({'background-color': 'rgba(255, 255, 255, 1)'});
    $('#frameDialog h3[class*="dialogTitle"]').removeClass().addClass('dialogTitle480');
    $('table[class*="fbnTable"]').removeClass().addClass('fbnTable480');
    ($('#txaFeedback').hasClass('fieldError'))? 
        $('#txaFeedback').removeClass().addClass('fb480 fieldError'):
        $('#txaFeedback').removeClass().addClass('fb480');
    $('#txaSelected').removeClass().addClass('fb480');
    ($('#txaComment').hasClass('fieldError'))? 
        $('#txaComment').removeClass().addClass('fb480 fieldError'):
        $('#txaComment').removeClass().addClass('fb480');
    $('td[class*="fbFeedback"]').removeClass().addClass('fbFeedback480');
    $('td[class*="fbSelected"]').removeClass().addClass('fbSelected480');
    $('div[class*="emailFlex"]').removeClass().addClass('emailFlex480');
    $('div[class*="lblEmailAddress"]').removeClass().addClass('lblEmailAddress480');
    ($('#txtEmailAddress').hasClass('fieldError'))? 
        $('#txtEmailAddress').removeClass().addClass('fb480 fieldError'):
        $('#txtEmailAddress').removeClass().addClass('fb480');
    $('#rememberMe').removeClass().addClass('fb480');
    $('#chkRememberMe').removeClass().addClass('fb480');
    $('table#fbnButtons').removeClass().addClass('fb480');
    $('#btnClose').removeClass().addClass('fb480');
    $('#grey_overlay').removeClass().addClass('fb480');
    $('#txaFeedback_Error.on').removeClass().addClass('on fb480');
    $('#txaComment_Error.on').removeClass().addClass('on fb480');
    $('#txtEmailAddress_Error.on').removeClass().addClass('on fb480');
    $('#txtEmailAddress_Error.onYN').removeClass().addClass('onYN fb480');
    $('#fbnCaptcha_Error.on').removeClass().addClass('on fb480');
    $('#fbnCaptcha_Error.onYN').removeClass().addClass('onYN fb480');
    $('div#valTrig').removeClass().addClass('fb480');
}

//****************************************************************************
// Desc: Due to CSS @media bug in chromium | maps classes to viewfield
//****************************************************************************
FB.applyStyle320 = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.applyStyle320');

    $('div#frameDialog').css({'background-color': 'rgba(255, 255, 255, 1)'});
    $('#frameDialog h3[class*="dialogTitle"]').removeClass().addClass('dialogTitle320');
    $('table[class*="fbnTable"]').removeClass().addClass('fbnTable320');
    ($('#txaFeedback').hasClass('fieldError'))? 
        $('#txaFeedback').removeClass().addClass('fb320 fieldError'):
        $('#txaFeedback').removeClass().addClass('fb320');
    $('#txaSelected').removeClass().addClass('fb320');
    ($('#txaComment').hasClass('fieldError'))? 
        $('#txaComment').removeClass().addClass('fb320 fieldError'):
        $('#txaComment').removeClass().addClass('fb320');
    $('td[class*="fbFeedback"]').removeClass().addClass('fbFeedback320');
    $('td[class*="fbSelected"]').removeClass().addClass('fbSelected320');
    $('div[class*="emailFlex"]').removeClass().addClass('emailFlex320');
    $('div[class*="lblEmailAddress"]').removeClass().addClass('lblEmailAddress320');
    ($('#txtEmailAddress').hasClass('fieldError'))? 
        $('#txtEmailAddress').removeClass().addClass('fb320 fieldError'):
        $('#txtEmailAddress').removeClass().addClass('fb320');
    $('#rememberMe').removeClass().addClass('fb320');
    $('#chkRememberMe').removeClass().addClass('fb320');
    $('table#fbnButtons').removeClass().addClass('fb320');
    $('#btnClose').removeClass().addClass('fb320');
    $('#grey_overlay').removeClass().addClass('fb320');
    $('#txaFeedback_Error.on').removeClass().addClass('on fb320');
    $('#txaComment_Error.on').removeClass().addClass('on fb320');
    $('#txtEmailAddress_Error.on').removeClass().addClass('on fb320');
    $('#txtEmailAddress_Error.onYN').removeClass().addClass('onYN fb320');
    $('#fbnCaptcha_Error.on').removeClass().addClass('on fb320');
    $('#fbnCaptcha_Error.onYN').removeClass().addClass('onYN fb320');
    $('div#valTrig').removeClass().addClass('fb320');
}

//****************************************************************************
// Desc: Positioning helper
//****************************************************************************
FB.offset = function(poElm) 
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.offset');

    if(poElm != null)
    {
        var rect, scrollLeft, scrollTop;

        rect = poElm.getBoundingClientRect(),
        scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,
        scrollTop  = window.pageYOffset || document.documentElement.scrollTop;

        return { top: rect.top + scrollTop, left: rect.left + scrollLeft }
    }
    else
    {
        return { top: -1, left: -1}
    }
}

//****************************************************************************
// Desc:
//****************************************************************************
FB.positionValTrig = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'FB.positionValTrig');

    clearTimeout(FB.posValTrig);
    $('div#valTrig').show();
    FB.activeTrigger = true;
}

//****************************************************************************
SP.SOD.executeFunc('sp.js', 'SP.ClientContext', FB.init);
//****************************************************************************
window.onbeforeunload = function()
{
    if(FB.debug)
        console.log(FB.getCounter() + 'window.onbeforeunload');

    switch(FB.formType)
    {
        case 'CrowdSourcing': 
            top.fbn.formSwitch  = 'Thank-You';
            top.fbn.formTYTitle = 'Thank you for your suggestion';
            top.fbn.line_1      = 'We will review your suggestion and let you know the outcome.';      
            top.fbn.line_2      = 'We may be in touch if we require any further information.';
            top.fbn.line_3      = '';
            break;
        case 'Helpful':
            top.fbn.formSwitch  = 'Thank-You';
            top.fbn.formTYTitle = 'Thank you for your feedback';
            top.fbn.line_1      = 'If you provided your email address';      
            top.fbn.line_2      = 'we\'ll be in touch.';
            top.fbn.line_3      = '';
            break;
        default:
            top.fbn.formSwitch  = '';
    }
    top.fbn._Close();
}

//****************************************************************************