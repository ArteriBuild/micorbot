{/* Copyright (c) 2021 AWE ****************************************************
'*  Name:        feedback.js 
'*  Description: Global javascipt snippets.
'*  Email:       wilson.wampers@gmail.com
'*  Notes:       navigator.clipboard is only supported in chromium browsers
'*               document.executeCommand('paste') cannot not be invoked using js
'*****************************************************************************
'*  Modification History:
'*  -When           -Who            -Bug#           -What
'*  --------------------------------------------------------------------------
'*	-28-Apr-2021    -Wilson Wampers -               -Initial Version
'***************************************************************************
   LM: ww.221222.2021_P */}
// Global Variables
var fb = fb || {};

fb.bShowSize = false;//  Resizing Dashboard, use only when trying to examine resizing issues, it's resource impacting.
fb.selection = null;
fb.selectedText = '';
fb.passed = false;
fb.authoring = '';
fb.outerHtml = '';
// Load the feedback form script
global.fbnf_js_Url = global.micor2020Path + 'js/fbnf.min.js';
global.loadScript(global.fbnf_js_Url); 

//****************************************************************************
// Desc: jQuery outerHTML // jQuery extension
//****************************************************************************
jQuery.fn.outerHTML = function(s) 
{
    return s
        ? this.before(s).remove()
        : jQuery("<p>").append(this.eq(0).clone()).html();
};

//****************************************************************************
// Desc:  
//****************************************************************************
fb.init = function()
{
    $(document).ready(function()
    {// Hide the sign-in button section
        $('head').prepend('<meta name="viewport" content="width=device-width, initial-scale=1.0">');

        if(fb.bShowSize)
        {
            $('div.ms-core-brandingText').prepend(
                '<div class="resizeWidth">'
                + $('body').width()+' x '+$('body').height()
                + '<div>'); 
            $(window).on('resize', function()
            {
                $('.resizeWidth').text($('body').width()+' x '+$('body').height() );
            });
        }

        $('a.ms-signInLink').parent().css({ display: 'none'});
        // Avoid feadback when authoring
        if(global.verbose) console.log('Authoring: ' + (($('#MSOLayout_InDesignMode').val()!=1) ? 'off' : 'on'));
        var sHtml = '';

        if($('#MSOLayout_InDesignMode').val() != 1)
        {
            console.log('feedback.js -> loaded');
            var stylesheet = ((global.IEVersion == -1)? 'css/feedback.css': 'css/feedbackIE.css');
            // alert('loading stylesheet: ' + stylesheet);
            var styleSheetUrl = global.micor2020Path + stylesheet;
            global.loadCss(styleSheetUrl);

            sHtml += '<div id="DivYesNo">'
                    +'\n<span class="helpful">'
                    +'\n<span class="page-helpful">Was this page helpful?</span>'
                    +'<span class="phBtnDiv">'
                    +'&nbsp;&nbsp;<input type="button" id="btnYes" value="Yes"/>'
                    +'&nbsp;&nbsp;<input type="button" id="btnNo" value="No"/>'
                    +'</span>\n</span>'
                    +'\n</div>';
            $('div.contentdisclaimer').before(sHtml);
            $('div#DivYesNo').show();

            sHtml =  '';
            sHtml += '<div class="outputText"></div>';
            $('#DeltaPlaceHolderMain').wrapInner('<div class="fb_Scroll_Pos_Wrap"></div>');
            if(!$('div.outputText').length)
            {
                $('footer').prepend(sHtml);
            }

            fb.enableUserSelect();

            $('form').on('mousedown', function(e)
            {
                switch(e.which)
                {// Only accept left mouse button press
                    case 1: 
                            fb.clearOutput(); 
                            fb.passed = false;
                            break;
                }
            }); 
            $('#btnYes').on('click', function()
            {
                fbn.init('Yes');
            });
            $('#btnNo').on('click', function()
            {
                fbn.init('No');
            });
        }
    });
}

//****************************************************************************
// Desc: 
//***************************************************************************
fb.enableUserSelect = function()
{
    $('form').on('mouseup', function(e)
    {
        switch(e.which)
        {// Only accept left mouse button press
            case 1:
            {
                if(window.getSelection() != null) 
                {
                    fb.getSelectedText(e);
                }

                fb.selection = null;
                break;
            }
        }
    });
}

//****************************************************************************
// Desc: 
//****************************************************************************
fb.clearOutput = function()
{
    $('div.output').html('');
    fb.enableUserSelect();
    
    if( window.getSelection ) 
    {
        if( window.getSelection().empty ) 
        {// Chrome
            window.getSelection().empty();
        } 
        else if( window.getSelection().removeAllRanges ) 
        {// Firefox
            window.getSelection().removeAllRanges();
        }
    } 
    else if( document.selection ) 
    {// IE?
        document.selection.empty();
    }

    $('.selElm').removeClass('selElm');
    $('div.btnFeedback').remove();
    fb.selection = null;
}

//****************************************************************************
// Desc: Positioning helper
//****************************************************************************
fb.offset = function(poElm) 
{
    var rect, scrollLeft, scrollTop;

    rect = poElm.getBoundingClientRect(),
    scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,
    scrollTop  = window.pageYOffset || document.documentElement.scrollTop;

    return { top: rect.top + scrollTop, left: rect.left + scrollLeft }
}

//****************************************************************************
// Desc: Get's a referrence to a select event. Differs/browser
//****************************************************************************
fb.getSelectedText = function(e) 
{
    var ranges = new Array(), selectedText = '', sHtml = '', oElm, elmOffset, nLeft, nTop;
    if(!fb.passed)
    {
        fb.selection = window.getSelection();
        if(fb.selection != '')
            if(global.verbose) 
                console.log('Feedback selection text: ' + fb.selection);

        if((fb.selection.focusOffset != fb.selection.anchorOffset))
        {
            fb.outerHtml = $(fb.selection.focusNode).outerHTML();

            fb.selectedText = '' + fb.selection.getRangeAt(0);
            if(global.IEVersion != -1)
            {
                $('body').blur();
                var max = 10000, nCnt = -1;
                if(global.pathName.indexOf('micor.agriculture') != -1) max = 50000;
                
                while(true)
                {
                    if(nCnt > max) break;
                    nCnt++;
                }
                $('body').focus();
            }

            sHtml += '<div class="btnFeedback" title="Suggest a fix?" tabindex="0">';
            sHtml += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 125" version="1.1" x="0px" y="0px" title="Suggest a fix?"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M12,95 L88.9934728,95 L88.9934728,91.2819904 L12,91.2819904 L12,95 Z M77.5968438,56.5436969 L88.9934728,56.5436969 L88.9934728,52.8256873 L77.5968438,52.8256873 L77.5968438,56.5436969 Z M64.5735856,69.0529403 L88.9934728,69.0529403 L88.9934728,65.3349307 L64.5735856,65.3349307 L64.5735856,69.0529403 Z M50.6198955,81.9934728 L88.9934728,81.9934728 L88.9934728,78.2754632 L50.6198955,78.2754632 L50.6198955,81.9934728 Z M40.4344081,70.2371264 L23.7572759,53.5590647 L67.057216,10.2581951 L83.7352777,26.9362568 L40.4344081,70.2371264 Z M15.7180096,78.2754632 L15.7180096,61.598331 L21.1277136,56.1876975 L37.8057753,72.8657592 L32.3951418,78.2754632 L15.7180096,78.2754632 Z M88.9934728,26.9362568 L67.057216,5 L12,60.0581455 L12,81.9934728 L33.9353273,81.9934728 L88.9934728,26.9362568 Z" fill="#000000"/></g></svg>';
            sHtml += '</div>';

            $('div.layout-container').prepend(sHtml);
            $(fb.selection.focusNode).parent().addClass('selElm');

            fb.corrX = 19;
            if($('div#cnm').length != 0)
            { 
                fb.corrY = -122 
            }
            else
            { 
                fb.corrY = -72;
            }
            // No use inplementing feedback if we don't have the wrapper available
            if($('.fb_Scroll_Pos_Wrap').length)
            {
                oElm = document.querySelector('.fb_Scroll_Pos_Wrap');
                elmOffset = fb.offset(oElm);
                // console.log('scroll top: ' + elmOffset.top);
                nTop = e.pageY - fb.corrY - elmOffset.top;
                nLeft = e.pageX - fb.corrX - elmOffset.left;
                $('div.btnFeedback').css({top: nTop + 'px',left: nLeft + 'px'});
                $('div.btnFeedback').fadeIn(150);
                $('div.btnFeedback').on('mousedown', function(e)
                {
                    e.preventDefault();
                    e.stopPropagation();
                    switch(e.which)
                    {
                        case 1:// Left mouse button
                        {  
                            fb.populate();
                            break;
                        }
                        case 2:// Right mouse button: Gecko (Firefox), WebKit (Safari/Chrome) & Opera
                        case 3:// Right mouse button: IE, Opera
                        default: 
                        {
                            break;
                        }
                    }
                });
                $('div.btnFeedback').on('keydown', function(e)
                {
                    if (e.which == 13 || e.which == 32) 
                    {
                        e.preventDefault();
                        e.stopPropagation();
                        fb.populate();
                    }
                });
                $('div.output').html(fb.selectedText);
            }
            
            $('form').off('mouseup');
            fb.passed = true;
        }
    }

    return false;
}

//****************************************************************************
// Desc:
//****************************************************************************
fb.populate = function()
{
    var sUniClean;

    if(global.verbose) console.log(fb.selectedText);
    sUniClean = fb.selectedText.replace(/[\u200B-\u200D\uFEFF]/g, ''); 
    sUniClean = sUniClean.replace(/&ZeroWidthSpace;/g, '');
    $('div.outputText').text(sUniClean);
    if(global.verbose) console.log('feedback selected html: ' + fb.outerHtml);
    //$('div.outputHtml').html(ut.htmlEncode(fb.outerHtml));
    fbn.userSelHtml = fb.outerHtml;
    fb.clearOutput();
    fb.openFeedbackForm();
}

//****************************************************************************
// Desc: $('#feedbackWidget'); 
//****************************************************************************
fb.openFeedbackForm = function()
{
    fbn.init('Comment');
}

//****************************************************************************
SP.SOD.executeFunc('sp.js', 'SP.ClientContext', fb.init);
//****************************************************************************